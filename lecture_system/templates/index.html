<!DOCTYPE html>
<html>
<head>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='main.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/1.2.0/tailwind.min.css" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

    <script type="text/javascript" charset="utf-8">

        function initializeChart(DOMelement) {
            const ms = 40;
            const layout_template = {
                title: DOMelement.id,
                margin: { l: ms, r: ms, t: ms, b: ms+20 },
                padding: 40,
                legend: { orientation: 'h' },
                xaxis: { title: "Time" },
                yaxis: { title: "Loudness (dB)" },
                yaxis2: { title: "Gain (db) ", side: "right", overlaying: "y"},
                autosize: true,
                height: 320,
                font: { family: "arial" }
            };
            const config = {
                displayModeBar: false,
                responsive: true
            };
            let traces = [{
                name: "Loudness",
                y: [0],
                type: 'line'
            }];
            let isSpeaker = DOMelement.id.includes('speaker');
            
            if (isSpeaker) {
                traces.push({
                    name: "Gain",
                    y: [0],
                    type: 'line',
                    yaxis: 'y2'
                });
            }


            Plotly.newPlot(DOMelement, traces, layout_template, config)
        }

        $(document).ready(function(){
            //connect to the socket server.
            var socket = io.connect('http://' + document.domain + ':' + location.port + '/');

            const sensor_divs = $('.sensor').toArray();
            const speaker_divs = $('.speaker').toArray();
            const chart_divs = sensor_divs.concat(speaker_divs);


            //receive details from server
            socket.on('system_update', function(msg) {
                const {roomlayout, eventcounter} = msg.data;

                // update html table and room layout
                $('#roomlayout').html(roomlayout);

                if (eventcounter === 100) {
                    chart_divs.forEach(chart_div => {
                        initializeChart(chart_div);
                    });
                }

            });

            // event to update box graphs
            socket.on('update_graphs', function(msg) {
                const {readings, eventcounter} = msg.data;
                cnt = eventcounter / 100;
                const offset = 10;;

                // update speaker box graphs
                if (eventcounter > 1) {
                    speaker_divs.forEach((speaker, i) => {
                        Plotly.extendTraces(speaker, {
                            y: [
                                [readings.speakers[i].loudness],
                                [readings.speakers[i].gain]
                            ]
                        }, [0, 1]);
                    });

                    sensor_divs.forEach((sensor, i) => {
                        Plotly.extendTraces(sensor, {
                            y: [[readings.sensors[i].loudness]]
                        }, [0]);
                    })
                }

                if (eventcounter > offset) {
                    chart_divs.forEach(DOMelement => {
                        Plotly.relayout(DOMelement, {
                            xaxis: { range: [cnt - offset, cnt] }
                        });
                    })
                }
                
            })
            
            $( "#target" ).change(function() {
                socket.emit('set target', $(this).val());
              });

            $("button").click(function() {
                socket.emit('set target', $('#target').val());
            })
        });


    </script>
</head>

<body style="font-family: Arial">
    <main class='main'>

        <div class="w-full bg-gray-800 text-white p-3">
          <label for="target">Target dB value:</label>
          <input type="number" id="target"
          name="target" min="1" max="100" value='60'
          class="text-gray-800 p-2 border-none rounded-sm"
          >
          <button class="bg-green-300 text-gray-800 py-2 px-4 rounded-sm">
            Enter
          </button>
        </div>
        

        <div class="bg-gray-200 flex flex-col">
          <div class="bg-gray-200 flex justify-between">
            <div class="bg-white flex-1 mr-2 p-2"><div id="sensor1" class="sensor"></div></div>
            <div class="bg-white flex-1 mr-2 p-2"><div id="sensor2" class="sensor"></div></div>
            <div class="bg-white flex-1 p-2"><div id="sensor3" class="sensor"></div></div>
          </div>

          <div class="bg-gray-200 mt-2 flex justify-between">
            <div class="bg-white mr-2 flex-1"><div id="speaker1" class="speaker"></div></div>
            <div class="flex-1 mr-2 bg-white">
                <div id="room" class="p-2">
                    <div id="roomlayout"></div>
                    <div style='text-align: center'>Front of Room</div>
                </div>
            </div>
            <div class="bg-white flex-1 p-2"><div id="speaker2" class="speaker"></div></div>
          </div>
        </div>

    </main>

</body>
</html>