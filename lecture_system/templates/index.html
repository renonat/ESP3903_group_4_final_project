<!DOCTYPE html>
<html>
<head>
	<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='main.css') }}">

	<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

	<script type="text/javascript" charset="utf-8">

		function initializeChart(DOMelement) {
			const ms = 40;
			const layout_template = {
				title: DOMelement.id,
				margin: { l: ms, r: ms, t: ms, b: ms },
				padding: 40,
				legend: { orientation: 'h' },
				xaxis: { title: "Time" },
				yaxis: { title: "Loudness (dB)" },
				yaxis2: {
					title: "Gain (dB)",
					overlaying: 'y',
					side: 'right'
				}
			};
			const config = { displayModeBar: false };
			let traces = [{
				name: "Loudness",
				y: [],
				type: 'line'
			}];
			let isSpeaker = DOMelement.id.includes('speaker');
			
			if (isSpeaker) {
				traces.push({
					name: "Gain",
					y: [],
					type: 'line',
					yaxis: 'y2'
				});
			}


			Plotly.newPlot(DOMelement, traces, layout_template, config)
		}

		$(document).ready(function(){
			//connect to the socket server.
			var socket = io.connect('http://' + document.domain + ':' + location.port + '/');

			const sensor_divs = $('.sensor').toArray();
			const speaker_divs = $('.speaker').toArray();
			const chart_divs = sensor_divs.concat(speaker_divs);

			chart_divs.forEach(chart_div => {
				initializeChart(chart_div);
			});

			// testig whether slower event updates helps
			socket.on('update_graphs', function(msg) {
				const {readings} = msg.data;

				//update speaker graphs
				speaker_divs.forEach((speaker, i) => {
					Plotly.extendTraces(speaker, {
						y: [
							[readings.speakers[i].loudness],
							[readings.speakers[i].gain]
						]
					}, [0, 1]);
				});

				sensor_divs.forEach((sensor, i) => {
					Plotly.extendTraces(sensor, {
						y: [[readings.sensors[i].loudness]]
					}, [0]);
				})
			})
			
			//receive details from server
			socket.on('system_update', function(msg) {
				const {roomlayout} = msg.data;

				// update html table and room layout
				// $('#log').html(table);
				$('#roomlayout').html(roomlayout);

			});
		});
	</script>
</head>

<body>
	<!-- <div id="log"></div> -->

	<main class='main'>

		<div class="row">
			<div id="sensor1" class="graph sensor"></div>
			<div id="sensor2" class="graph sensor"></div>
			<div id="sensor3" class="graph sensor"></div>
		</div>

		<div class="row">
			<div id="speaker1" class="graph speaker"></div>

			<div id="room" class="graph">
				<div style='text-align: center'>Front of Room</div>

				<div id="roomlayout" 
					style="border-style: solid; border-width: thin; background-color: #efe5d2; max-width: 100%; overflow-x: scroll;">
				</div>
			</div>

			<div id="speaker2" class="graph speaker"></div>
		</div>
	</main>

</body>
</html>